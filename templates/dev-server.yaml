# Development Server Template
# Template for deploying development and testing servers

name: "dev-server"
description: "Development server configuration with common tools"
version: "1.0"

# Default configuration
defaults:
  server_type: "cax11" # ARM 2 vCPU, 4GB RAM - cost-effective for dev
  image: "ubuntu-24.04" # Latest Ubuntu LTS
  location: "fsn1" # Falkenstein (EU-Central)

# Networking
network:
  ipv4: true
  ipv6: false # Simplified networking for dev
  firewall: "dev-firewall" # Development firewall rules

# Tags and labels
labels:
  environment: "development"
  role: "dev-server"
  managed-by: "hcloud-multi"
  backup: "disabled"
  auto-shutdown: "enabled" # Can be auto-stopped to save costs

# Post-deployment scripts
user_data: |
  #!/bin/bash
  set -e

  # Update system
  apt update && apt upgrade -y

  # Install development tools
  apt install -y \
    curl wget git vim nano \
    htop tree unzip zip \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release

  # Install Docker
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  apt update
  apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

  # Install Docker Compose (standalone)
  curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
  chmod +x /usr/local/bin/docker-compose

  # Install Node.js (Latest LTS)
  curl -fsSL https://deb.nodesource.com/setup_lts.x | bash -
  apt install -y nodejs

  # Install Python tools
  apt install -y python3 python3-pip python3-venv
  pip3 install --upgrade pip virtualenv

  # Install Go
  GO_VERSION="1.21.5"
  wget -q "https://golang.org/dl/go${GO_VERSION}.linux-amd64.tar.gz"
  tar -C /usr/local -xzf "go${GO_VERSION}.linux-amd64.tar.gz"
  rm "go${GO_VERSION}.linux-amd64.tar.gz"

  # Add Go to PATH for all users
  echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
  echo 'export GOPATH=$HOME/go' >> /etc/profile

  # Install VS Code Server (code-server)
  curl -fsSL https://code-server.dev/install.sh | sh

  # Configure code-server
  mkdir -p /root/.config/code-server
  cat > /root/.config/code-server/config.yaml << 'EOF'
  bind-addr: 0.0.0.0:8080
  auth: password
  password: devserver123
  cert: false
  EOF

  # Create systemd service for code-server
  systemctl enable --now code-server@root

  # Basic firewall setup
  ufw allow 22/tcp          # SSH
  ufw allow 8080/tcp        # VS Code Server
  ufw allow 3000/tcp        # Common dev port
  ufw allow 8000/tcp        # Common dev port
  ufw allow 9000/tcp        # Common dev port
  ufw --force enable

  # Create development workspace
  mkdir -p /root/workspace
  cd /root/workspace

  # Create useful scripts
  cat > /root/dev-tools.sh << 'EOF'
  #!/bin/bash
  echo "=== Development Server Tools ==="
  echo "Docker:         $(docker --version)"
  echo "Docker Compose: $(docker-compose --version)"
  echo "Node.js:        $(node --version)"
  echo "npm:            $(npm --version)"
  echo "Python:         $(python3 --version)"
  echo "Go:             $(go version 2>/dev/null || echo 'Not in PATH')"
  echo "Git:            $(git --version)"
  echo ""
  echo "Services:"
  echo "VS Code Server: http://$(curl -s ifconfig.me):8080 (password: devserver123)"
  echo "Docker:         $(systemctl is-active docker)"
  echo ""
  echo "Workspace:      /root/workspace"
  echo "Logs:           journalctl -u code-server@root"
  EOF
  chmod +x /root/dev-tools.sh

  # Create Docker development environment
  cat > /root/workspace/docker-compose.dev.yml << 'EOF'
  version: '3.8'
  services:
    postgres:
      image: postgres:15
      environment:
        POSTGRES_DB: devdb
        POSTGRES_USER: dev
        POSTGRES_PASSWORD: devpass
      ports:
        - "5432:5432"
      volumes:
        - postgres_data:/var/lib/postgresql/data

    redis:
      image: redis:7-alpine
      ports:
        - "6379:6379"

    nginx:
      image: nginx:alpine
      ports:
        - "80:80"
      volumes:
        - ./nginx.conf:/etc/nginx/nginx.conf:ro

  volumes:
    postgres_data:
  EOF

  # Create development motd
  cat > /etc/motd << 'EOF'

   ____             ____
  |  _ \  _____   _/ ___|  ___ _ ____   _____ _ __
  | | | |/ _ \ \ / /\___ \ / _ \ '__\ \ / / _ \ '__|
  | |_| |  __/\ V /  ___) |  __/ |   \ V /  __/ |
  |____/ \___| \_/  |____/ \___|_|    \_/ \___|_|

  Development Server Ready!

  Quick Start:
  - Run: /root/dev-tools.sh for tool overview
  - VS Code: http://YOUR_IP:8080 (password: devserver123)
  - Workspace: /root/workspace
  - Docker: docker ps, docker-compose up

  EOF

  # Install common development extensions for code-server
  code-server --install-extension ms-python.python
  code-server --install-extension golang.go
  code-server --install-extension ms-vscode.vscode-typescript-next
  code-server --install-extension bradlc.vscode-tailwindcss
  code-server --install-extension ms-vscode.vscode-json

  # Log successful installation
  echo "$(date): Development server setup completed" >> /var/log/dev-setup.log
  /root/dev-tools.sh >> /var/log/dev-setup.log

# Cost estimate
cost:
  monthly_estimate: "€3.79"
  breakdown:
    server: "€3.29" # CAX11 ARM server
    ipv4: "€0.50" # IPv4 address
  daily_cost: "€0.13"
  hourly_cost: "€0.005"

# Development specific configuration
development:
  default_ports:
    ssh: 22
    vscode: 8080
    webapp: 3000
    api: 8000
    debug: 9000
    postgres: 5432
    redis: 6379

  # Installed tools
  tools:
    - "Docker & Docker Compose"
    - "Node.js LTS & npm"
    - "Python 3 & pip"
    - "Go programming language"
    - "VS Code Server (web-based IDE)"
    - "Git version control"
    - "PostgreSQL & Redis (via Docker)"

  # VS Code extensions
  vscode_extensions:
    - "ms-python.python"
    - "golang.go"
    - "ms-vscode.vscode-typescript-next"
    - "bradlc.vscode-tailwindcss"
    - "ms-vscode.vscode-json"

# Firewall rules for development
firewall_rules:
  - name: "ssh"
    port: "22"
    protocol: "tcp"
    direction: "in"
  - name: "vscode-server"
    port: "8080"
    protocol: "tcp"
    direction: "in"
  - name: "dev-webapp"
    port: "3000"
    protocol: "tcp"
    direction: "in"
  - name: "dev-api"
    port: "8000"
    protocol: "tcp"
    direction: "in"
  - name: "dev-debug"
    port: "9000"
    protocol: "tcp"
    direction: "in"

# Auto-shutdown for cost savings
auto_shutdown:
  enabled: true
  schedule: "0 2 * * *" # 2 AM daily
  exclude_days: ["Saturday", "Sunday"]
  warning_time: "15min"

# Backup configuration
backup:
  enabled: false # Development data is typically not critical
  workspace_backup: true # Backup only the workspace directory
  schedule: "weekly"

# Performance tuning for development
performance:
  swap_enabled: true # Enable swap for compilation tasks
  swap_size: "2G"
  docker_optimization: true # Optimize Docker for development

# Scaling options
scaling:
  min_servers: 0 # Can be completely shut down
  max_servers: 3 # Multiple dev environments
  purpose: "development"
  cost_conscious: true # Prioritize cost over performance
